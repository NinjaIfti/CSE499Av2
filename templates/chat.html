{% extends "base.html" %}

{% block title %}Chat - Lecture #{{ lecture.id }} - Lecture AI{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        max-width: 900px;
        margin: 0 auto;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: #f9f9f9;
    }
    .message {
        margin-bottom: 15px;
    }
    .message-question {
        background: #e3f2fd;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
    }
    .message-answer {
        background: #f1f8e9;
        padding: 10px 15px;
        border-radius: 8px;
    }
    .message-time {
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
    }
    .chat-input-form {
        display: flex;
        gap: 10px;
    }
    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 10px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="lecture-header">
    <h2>Chat with Lecture #{{ lecture.id }}</h2>
    <a href="{{ url_for('lecture_view', lecture_id=lecture.id) }}" class="btn btn-secondary">Back to Lecture</a>
</div>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% if chat_history %}
            {% for chat in chat_history %}
                <div class="message">
                    <div class="message-question">
                        <strong>You:</strong> {{ chat.question }}
                    </div>
                    <div class="message-answer">
                        <strong>Assistant:</strong> {{ chat.answer }}
                    </div>
                    <div class="message-time">{{ chat.created_at }}</div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No messages yet. Start a conversation!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="loading" id="loading">Processing your question...</div>
    
    <form class="chat-input-form" id="chatForm">
        <input type="text" 
               class="chat-input" 
               id="questionInput" 
               placeholder="Ask a question about this lecture..." 
               required>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</div>

<script>
    const chatForm = document.getElementById('chatForm');
    const questionInput = document.getElementById('questionInput');
    const chatMessages = document.getElementById('chatMessages');
    const loading = document.getElementById('loading');
    
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) return;
        
        // Add user question to chat
        const questionDiv = document.createElement('div');
        questionDiv.className = 'message';
        questionDiv.innerHTML = `
            <div class="message-question">
                <strong>You:</strong> ${escapeHtml(question)}
            </div>
        `;
        chatMessages.appendChild(questionDiv);
        
        // Clear input and show loading
        questionInput.value = '';
        loading.style.display = 'block';
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
            const response = await fetch('{{ url_for("api_chat", lecture_id=lecture.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'message-answer';
                answerDiv.innerHTML = `<strong>Assistant:</strong> ${escapeHtml(data.answer)}`;
                questionDiv.appendChild(answerDiv);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleString();
                questionDiv.appendChild(timeDiv);
            } else {
                throw new Error(data.error || 'Failed to get response');
            }
        } catch (error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message-answer';
            errorDiv.style.background = '#ffebee';
            errorDiv.innerHTML = `<strong>Error:</strong> ${escapeHtml(error.message)}`;
            questionDiv.appendChild(errorDiv);
        } finally {
            loading.style.display = 'none';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
